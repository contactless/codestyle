Руководство по стилю Wiren Board Embedded C
========================

Следующий документ описывает несколько рекомендаций для облегчения чтения 
и написания хорошо организованного программного кода, ориентированный на язык программирования C, который может отличаться от соглашений C ++.

## Кодировка
Все файлы должны быть созданы в кодировке UTF-8. Конец файла всегда заканчивается переводом строки

## Выравнивание
Пробелы

1. Отступы 4 пробела между блоками - не использовать символ табуляции (TAB)
2. Пробелами разделяются знаки + != = == - / ... с двух сторон
3. Пробелы между функциями и if
4. Аргументы функций перечисляются без пробелов
5. Значения макросов от 40 до 60 знакоместа с начала строки сдвигать пробелами кратно 4 символам.

Отступы, пробелы можно проверять, например, используя команды git diff и git diff master.

Не использовать отступы для выравнивания
```C
static uint16_t task_next_free_id[TASK_TYPE_NUMBER] = {GET_TASK_ID(TASK_IMMEDIATE, 0),
                                                       GET_TASK_ID(TASK_BACKGROUND, 0)};
```
лучше так:
```C
static uint16_t task_next_free_id[TASK_TYPE_NUMBER] = {
    GET_TASK_ID(TASK_IMMEDIATE, 0),
    GET_TASK_ID(TASK_BACKGROUND, 0)
};
```

допустима запись:
```C
    hlw8012_channels_state[channel].energy_factor = fix16_to_int(
        fix16_mul(
            fix16_div(
                fix16_from_int(
                    hlw8012_channel_defs[channel].energy_unit_time
                ),
                hlw8012_channels_state[channel].value_factor
            ),
            F16(HLW8012_PULSE_COUNTING_FACTOR)
        )
    );
```
вместо
```C
    hlw8012_channels_state[channel].energy_factor = fix16_to_int(fix16_mul(fix16_div(fix16_from_int(hlw8012_channel_defs[channel].energy_unit_time),hlw8012_channels_state[channel].value_factor),F16(HLW8012_PULSE_COUNTING_FACTOR)));
```
  или
```C  
    hlw8012_channels_state[channel].energy_factor = fix16_to_int(fix16_mul(fix16_div(fix16_from_int(hlw8012_channel_defs[channel].energy_unit_time),
                                 hlw8012_channels_state[channel].value_factor),F16(HLW8012_PULSE_COUNTING_FACTOR)));
```
## Обозначение и скобки
Они похожи на те, что мы использовали в C ++. Подробнее читайте: https://github.com/contactless/codestyle.

Перенос скобки на следущую строку начала определения осуществляется в функциях, в остальном нет.
Расстановка скобок:
```C
void function(void)
{
    if (a == b) {
    // single str action use brackets
    }

    if (c == d) {
    // do if equal
    } else {
    // do if not equal
    }
}
```
Всегда скобки, даже когда тело 1 строчка и даже когда его нет:
```C
while () {};

if () {
    return 0;
} else {
    return 1;
}
```

## Именование

Во встроенном C мы не следуем стилю CamelCase, а используем snake_case. В стиле snake_case имена переменных и функций могут
включать ** только символы нижнего регистра **, например * snake_case * (хотя официально разрешены также символы верхнего регистра), а слова должны быть разделены символом подчеркивания (_).

## Именование библиотеки
1. Когда вы добавляете новый модуль в свой проект, вы должны поместить его в новую библиотеку.
2. Избегайте таких библиотек, как *peripherals.h*.
3. Имена библиотек должны описывать модуль, стоящий за кодом. Используйте * mcp230xx.h * вместо * gpio_chip.h *
4. Постарайтесь разделить функциональные возможности модулей, чтобы обеспечить возможность повторного использования кода. Лучше реализовать базовую ИС
  связанные функции в одной библиотеке и написание функций для конкретных задач в другой библиотеке. Например: * mcp230xx.h * включает
  драйвер к микросхеме и * wbio-dio.h "библиотека использует функции * mcp230xx.h".
  
## Названия функций
Поскольку в C нет возможности использовать пространство имен или классы, вы должны каким-то образом пометить библиотеку своей функции и избегать такого рода
программного кода в * main.c *:
```C
int pin_value = read_value_digit (); // функция для module1
set_config (CONFIG_1);               // функция для module2
```
Лучше пометить имя библиотеки как префикс для каждой функции, даже если это статическая функция и используется только в данной библиотеке:
```C
int pin_value = mcp230xx_read_gpio ();
ads1015_set_config (ADS_CONFIG_1);
```
Это также верно для *defines*, где вы должны отметить, где это определено:
```C
#define MCP23008_IODIR      0x00
#define MCP23008_IPOL       0x01
#define MCP23008_GPINTEN    0x02
#define MCP23008_DEFVAL     0x03
#define MCP23008_INTCON     0x04
```

## Объявления
1. Функции, которые не предполагается вызывать извне библиотеки, должны быть определены как *static*.
2. Прототипы статических функций должны быть в файле * .c *, потому что это связано с реализацией, а не с использованием.
3. *#defines*, используемый только в * .c *, также должен быть помещен в * .c * файл.
4. В заголовочном файле должны быть *#defines* и функции, которые необходимы для использования библиотеки.
5. Избегайте использования жестко запрограммированных констант, потому что, во-первых, они не описывают свою функциональность, а во-вторых, их сложнее изменить
если когда-то это потребуется. Избегайте этого:
```C
uint16_t gpio_config = mcp230xx_read_config ();
if (gpio_config & 0x04) {
...
```
Лучше использовать *define* и заменить магическую константу.
```C
#define MCP230xx_REG_IOCON_BANK (1 << 2)
...
uint16_t gpio_config = mcp230xx_read_config ();
если (gpio_config & MCP230xx_REG_IOCON_BANK) {
...
```
Ранее допущенные ошибки форматирования исправляются в отдельной ветке с ПР согласно кодстайлу. 
